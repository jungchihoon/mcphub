# ğŸš€ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì—ì´ì „íŠ¸ Dockerfile
FROM node:18-alpine AS builder

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# íŒ¨í‚¤ì§€ íŒŒì¼ ë³µì‚¬
COPY package*.json ./
COPY tsconfig.json ./

# ì˜ì¡´ì„± ì„¤ì¹˜
RUN npm ci --only=production

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY src/services/performance-agent ./src/services/performance-agent
COPY src/types ./src/types

# TypeScript ì»´íŒŒì¼
RUN npm run build

# ğŸ³ í”„ë¡œë•ì…˜ ì´ë¯¸ì§€
FROM node:18-alpine AS production

# ë³´ì•ˆì„ ìœ„í•œ ë¹„ë£¨íŠ¸ ì‚¬ìš©ì ìƒì„±
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# íŒ¨í‚¤ì§€ íŒŒì¼ ë³µì‚¬
COPY package*.json ./

# í”„ë¡œë•ì…˜ ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜
RUN npm ci --only=production && npm cache clean --force

# ì»´íŒŒì¼ëœ ì½”ë“œ ë³µì‚¬
COPY --from=builder --chown=nodejs:nodejs /app/dist ./dist

# ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì—ì´ì „íŠ¸ ì „ìš© ì„¤ì •
ENV NODE_ENV=production
ENV PERFORMANCE_AGENT_PORT=9090

# ë¹„ë£¨íŠ¸ ì‚¬ìš©ìë¡œ ì „í™˜
USER nodejs

# í—¬ìŠ¤ ì²´í¬
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node -e "require('http').get('http://localhost:9090/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 9090

# ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì—ì´ì „íŠ¸ ì‹œì‘
CMD ["node", "dist/services/performance-agent/performanceAgent.js"]
