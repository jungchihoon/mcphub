# MCPHub v3.1.0 - 00시 정각 실행 기능

## 📅 릴리즈 정보

- **버전**: 3.1.0
- **릴리즈 날짜**: 2025-08-07
- **타입**: Feature Update
- **호환성**: v3.0.x와 완전 호환

## 🎯 주요 기능 추가

### 🕛 특정 시간 실행 스케줄러

MCPHub 환경변수 자동 관리 시스템이 이제 **매일 00시 정각** 또는 **사용자 지정 시간**에 실행될 수 있습니다.

#### 📋 기존 vs 신규

| 구분 | v3.0 (기존) | v3.1 (신규) |
|------|-------------|-------------|
| **실행 방식** | 서버 시작 후 N시간마다 | 매일 특정 시간에 실행 |
| **예측성** | 서버 재시작시 시간 변경 | 항상 동일한 시간 |
| **설정** | intervalHours만 지원 | scheduledTime 추가 |
| **UI** | 시간 간격 입력만 | 실행 방식 선택 + 시간 설정 |

#### 🔧 새로운 설정 옵션

```typescript
interface SchedulerConfig {
  enabled: boolean;
  intervalHours: number;        // 기존
  autoCleanup: boolean;         // 기존
  maxOrphanedKeys: number;      // 기존
  scheduledTime?: string;       // 🆕 NEW: "HH:MM" 형식
}
```

## 📝 변경된 파일 목록

### 🖥️ 백엔드 변경사항

#### 1. `src/services/envVarScheduler.ts` (대폭 개선)

**추가된 주요 메서드:**
- `scheduleAtSpecificTime()`: 특정 시간 스케줄링 로직
- `scheduleWithInterval()`: 기존 간격 기반 스케줄링
- `getNextScheduledTime()`: 다음 실행 시간 계산
- 개선된 `updateConfig()`: 스케줄 변경시 자동 재시작

**핵심 로직:**
```typescript
// 다음 실행 시간 계산
private getNextScheduledTime(): Date {
  const now = new Date();
  const [hours, minutes] = this.config.scheduledTime!.split(':').map(Number);
  
  const nextRun = new Date();
  nextRun.setHours(hours, minutes, 0, 0);
  
  // 오늘의 예정 시간이 이미 지났다면 내일로 설정
  if (nextRun <= now) {
    nextRun.setDate(nextRun.getDate() + 1);
  }
  
  return nextRun;
}
```

#### 2. `src/routes/index.ts` (API 확장)

**추가된 파라미터:**
```typescript
// POST /api/admin/env-scheduler/config
const { enabled, intervalHours, autoCleanup, maxOrphanedKeys, scheduledTime } = req.body;

scheduler.updateConfig({
  // ... 기존 파라미터들
  scheduledTime: scheduledTime !== undefined ? scheduledTime : undefined  // 🆕
});
```

#### 3. `src/server.ts` (초기화 로직)

**기본값 변경:**
```typescript
const schedulerConfig = {
  enabled: process.env.NODE_ENV === 'production',
  intervalHours: 24,
  autoCleanup: false,
  maxOrphanedKeys: 10,
  scheduledTime: "00:00"  // 🆕 기본값: 매일 00시
};
```

### 🎨 프론트엔드 변경사항

#### 1. `frontend/src/pages/admin/EnvVarManagementPage.tsx` (UI 개선)

**새로운 상태 추가:**
```typescript
const [schedulerConfig, setSchedulerConfig] = useState({
  enabled: false,
  intervalHours: 24,
  autoCleanup: false,
  maxOrphanedKeys: 10,
  scheduledTime: "00:00"  // 🆕
});
```

**UI 컴포넌트 추가:**
- **실행 방식 선택**: 드롭다운 (특정 시간 vs 주기적 실행)
- **시간 입력**: HTML time picker (`<input type="time">`)
- **상태 표시**: "매일 HH:MM" 형식으로 표시

#### 2. `frontend/src/layouts/AdminLayout.tsx` (메뉴 추가)

**관리자 메뉴에 환경변수 관리 추가:**
```typescript
{
  path: '/admin/env-vars',
  label: '환경변수 관리',
  icon: <Database className="h-5 w-5" />
}
```

#### 3. `frontend/src/App.tsx` (라우팅 추가)

**새로운 라우트:**
```tsx
<Route path="/admin/env-vars" element={<EnvVarManagementPage />} />
```

## 🔌 API 변경사항

### 새로운 요청/응답 형식

#### GET /api/admin/env-scheduler/status

**응답 변경:**
```json
{
  "success": true,
  "data": {
    "isRunning": true,
    "config": {
      "enabled": true,
      "intervalHours": 24,
      "autoCleanup": false,
      "maxOrphanedKeys": 10,
      "scheduledTime": "00:00"  // 🆕
    },
    "nextRunTime": "2025-08-07T15:00:00.000Z"
  }
}
```

#### POST /api/admin/env-scheduler/config

**요청 변경:**
```json
{
  "enabled": true,
  "intervalHours": 24,
  "autoCleanup": false,
  "maxOrphanedKeys": 10,
  "scheduledTime": "00:00"  // 🆕 선택사항
}
```

## 🎮 사용법

### 1. 환경변수 설정

```bash
# 개발 환경에서 스케줄러 활성화
ENV_SCHEDULER_ENABLED=true pnpm start:dev

# 기본값으로 00시 정각 실행
# 별도 설정 없이 자동으로 매일 00:00에 실행
```

### 2. API로 시간 변경

```bash
# 매일 00시 정각 설정
curl -X POST http://localhost:3000/api/admin/env-scheduler/config \
  -H "Content-Type: application/json" \
  -d '{"enabled": true, "scheduledTime": "00:00"}'

# 새벽 2시 30분 설정  
curl -X POST http://localhost:3000/api/admin/env-scheduler/config \
  -H "Content-Type: application/json" \
  -d '{"enabled": true, "scheduledTime": "02:30"}'

# 기존 간격 방식으로 변경 (12시간마다)
curl -X POST http://localhost:3000/api/admin/env-scheduler/config \
  -H "Content-Type: application/json" \
  -d '{"enabled": true, "intervalHours": 12, "scheduledTime": null}'
```

### 3. 웹 UI 사용법

1. **http://localhost:5173/admin/env-vars** 접속
2. **"실행 방식"** 선택:
   - `특정 시간에 실행`: 매일 지정된 시간
   - `주기적 실행`: N시간마다 반복
3. **시간 설정**:
   - 특정 시간: time picker로 HH:MM 입력
   - 주기적: 숫자 입력 (1-168시간)
4. **"설정 저장"** 클릭

## ⚡ 성능 및 안정성

### 메모리 사용량
- **기존**: setTimeout/setInterval 1개 
- **신규**: setTimeout + setInterval 조합 (메모리 사용량 동일)

### 정확성
- **특정 시간 모드**: 매일 정확히 지정된 시간에 실행
- **자동 보정**: 시스템 시간 변경 시에도 올바른 시간 계산

### 장애 대응
- **스케줄러 재시작**: 설정 변경 시 자동으로 이전 스케줄 정리 후 재시작
- **에러 처리**: 잘못된 시간 형식 입력 시 기본값으로 복원
- **로그 기록**: 모든 스케줄링 변경사항 상세 로그

## 🔍 트러블슈팅

### Q: 시간 설정이 반영되지 않아요
```bash
# 스케줄러 상태 확인
curl http://localhost:3000/api/admin/env-scheduler/status

# enabled: true인지 확인
# scheduledTime이 올바른 형식인지 확인 ("HH:MM")
```

### Q: 여전히 간격 기반으로 실행돼요
```bash
# scheduledTime을 명시적으로 설정
curl -X POST http://localhost:3000/api/admin/env-scheduler/config \
  -d '{"scheduledTime": "00:00"}'
```

### Q: 다음 실행 시간이 이상해요
- 시간대 설정 확인: 서버 로컬 시간 기준
- 한국 시간 00:00 = UTC 15:00 (여름시간 고려)

## 🚀 향후 계획

### v3.2 예정 기능
- **주간 스케줄**: 특정 요일에만 실행
- **다중 시간대**: 여러 시간에 실행
- **조건부 실행**: 고아 키 개수에 따른 실행 여부 결정
- **알림 연동**: 슬랙/이메일 실행 결과 통지

### 장기 로드맵
- **크론 표현식**: 더 복잡한 스케줄링 지원
- **실행 히스토리**: 과거 실행 기록 및 결과 저장
- **성능 모니터링**: 실행 시간 및 처리량 분석

## 🔗 관련 문서

- [환경변수 자동화 시스템 가이드](../mcphub-env-var-system.md)
- [API 레퍼런스](../api-reference.md)
- [관리자 가이드](../admin-guide.md)

---

**작성일**: 2025-08-07  
**작성자**: MCPHub 개발팀  
**검토자**: AI Assistant  
**승인자**: jungchihoon
